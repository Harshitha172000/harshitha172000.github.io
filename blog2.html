<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Harshitha's Blog</title>
	<link rel="stylesheet" href="fontawesome/css/all.min.css"> <!-- https://fontawesome.com/ -->
	<!--<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap" rel="stylesheet">  https://fonts.google.com/ -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/templatemo-xtra-blog.css" rel="stylesheet">
<!--
    
TemplateMo 553 Xtra Blog

https://templatemo.com/tm-553-xtra-blog

-->
</head>
<body>
        <body style="background-color:gainsboro">
	<header class="tm-header" id="tm-header">
        <div class="tm-header-wrapper">
            <button class="navbar-toggler" type="button" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="tm-site-header">
                
                <h1 class="text-center">Harshitha's Blog</h1>
            </div>
            <nav class="tm-nav" id="tm-nav">            
                <ul>
                    <li class="tm-nav-item"><a href="index.html" class="tm-nav-link">
                        <i class="fas fa-home"></i>
                        Home
                    </a></li>
                    <!--<li class="tm-nav-item active"><a href="post.html" class="tm-nav-link">
                        <i class="fas fa-pen"></i>
                        Posts
                    </a></li>-->
                    <li class="tm-nav-item"><a href="about.html" class="tm-nav-link">
                        <i class="fas fa-users"></i>
                        About Me
                    </a></li>
                    <!--<li class="tm-nav-item"><a href="contact.html" class="tm-nav-link">
                        <i class="far fa-comments"></i>
                        Contact 
                    </a></li>-->
                </ul>
            </nav>
            <div class="tm-mb-65">
                <a rel="nofollow" href="mailto:harshithasridhar172000@gmail.com" class="tm-social-link">
                    <i class="fa fa-envelope tm-social-icon"></i>
                </a>
                <a href="https://twitter.com/Harshit49678822" class="tm-social-link">
                    <i class="fab fa-twitter tm-social-icon"></i>
                </a>
                <a href="https://github.com/Harshitha172000" class="tm-social-link">
                    <i class="fab fa-github tm-social-icon"></i>
                </a>
                <a href="https://linkedin.com/in/harshitha-s-" class="tm-social-link">
                    <i class="fab fa-linkedin tm-social-icon"></i>
                </a>
            </div>
           
        </div>
    </header>
    <div class="container-fluid">
        <main class="tm-main">
            <!-- Search form 
            <div class="row tm-row">
                <div class="col-12">
                    <form method="GET" class="form-inline tm-mb-80 tm-search-form">                
                        <input class="form-control tm-search-input" name="query" type="text" placeholder="Search..." aria-label="Search">
                        <button class="tm-search-button" type="submit">
                            <i class="fas fa-search tm-search-icon" aria-hidden="true"></i>
                        </button>                                
                    </form>
                </div>                
            </div> -->   
                             

            <div class="row tm-row tm-mb-40">
                <div class="col-12">                                                       
                        <div class="mb-4">
                            <h2 class="pt-2 tm-mb-40 tm-color-primary tm-post-title"> Formal Verification of DPRAM and LRU Algorithm of Cache </h2>                       
                            <p class="tm-mb-40">June 5, 2021 </p>
<p>I am delighted to work with the <a href="http://openrisc.io/">OpenRISC</a> community as part of the <a href="https://www.fossi-foundation.org/">FOSSi Foundation</a> as I will contribute to the <a href="https://github.com/openrisc/mor1kx">Mor1kx</a> CPU in its formal verification. I had outlined the tasks of verification stages and my project flow for formal verification, which I have planned to complete in my <a href="http://harshitha172000.github.io/blog1">previous blog</a>. In this blog, I will elaborate on different formal methods that I could use in my project, and a sneak peek of my work.</p>
<p>This project is entirely dependent on <a href="http://www.clifford.at/yosys/">Yosys</a> tools, specifically <a href="https://symbiyosys.readthedocs.io/en/latest/">SymbiYosys</a> and <a href="http://www.clifford.at/papers/2016/yosys-smtbmc/">Yosys-smtbmc</a>. What does Yosys-smtbmc do? It applies formal methods to our code and mathematically proves that code works. If not, the solvers tell us where the code might fail.</p>
<br><h3 id="bmc-and-induction">BMC and Induction</h3>
<p>Before getting into the tool, it&#39;s essential to understand some terminologies like Bounded Model Check (BMC) and Induction. <a href="http://www.cs.cmu.edu/~emc/papers/Books%20and%20Edited%20Volumes/Bounded%20Model%20Checking.pdf">BMC</a> is the first step in Yosys-smtbmc theorem solving. Here, the solver starts with the initial state of the design and explores all the other states that it can encounter during its transitions. This method is bounded because it is time-limited and checks only a finite number of transitions.</p>
<p>To find out additional states, we follow the Induction step. It&#39;s just like <a href="https://en.wikipedia.org/wiki/Mathematical_induction">mathematical Induction</a>, where we first consider base case n=1 and prove that. Later, we check for n states and finally n+1. BMC is like a base case for k-induction.</p>
<br><h3 id="formal-declarations">Formal Declarations</h3>
<p>For any formal verification, basic operations like assert, assume, restrict and cover play a vital role. For a design, we need to assert some conditions to check if that holds for the design. If the design fails, it may be because the code fails or a flaw in the assertion. It is recommended to assert statements carefully.</p>
<p>To formally verify, do I need to understand the code? Definitely yes! Without knowing the code, it&#39;s impossible to assert conditions. Having an excellent exposure to design and its environment would help declare assertions quickly. We can also add constraints to the design space by including assume statements in the code.</p>
<p>With this basic idea, it&#39;s good to move ahead with <a href="http://www.clifford.at/papers/2016/yosys-synth-formal/">Yosys formal</a>. I have started my project earlier and have verified tiny modules like simple DPRAM, true DPRAM, and the least recently used algorithm. These modules are part of the instruction cache, data cache, and memory management unit.</p>
<br><h3 id="formally-verifying-mor1kx-s-dpram-lru-algorithm">Formally Verifying Mor1kx’s DPRAM, LRU Algorithm</h3>
<p>Mor1kx cache memory uses DPRAM to store its contents. The instruction cache is simple DPRAM based, and the data cache is true DPRAM based. </p>
<br><h4 id="simple-dpram">Simple DPRAM</h4>
<p>To check <a href="https://github.com/Harshitha172000/mor1kx/blob/formal/rtl/verilog/mor1kx_simple_dpram_sclk.v">simple dpram</a>’s correctness, I need to verify a few properties based on its code.</p>
<ol>
<p>1. On CLEAR, all the contents of the memory have to be initialized to zero.</p>
<p>2. On BYPASS, <code>dout</code> is the same as the <code>din</code> in the previous clock cycle.</p> 
<p>3. Verifying read or write operation on memory.</p>
</ol>

<pre style="background-color:darkgrey"><code> if (<span class="hljs-name">CLEAR_ON_INIT</span>) begin
        for (<span class="hljs-name">address</span> = <span class="hljs-number">0</span><span class="hljs-comment">; address &lt; (1&lt;&lt;ADDR_WIDTH); address = address + 1) </span>
           assert (<span class="hljs-name">mem</span>[address] == <span class="hljs-number">32</span>'d0)<span class="hljs-comment">;</span>
</code></pre><p>The above assertion checks for the first property which is straightforward.</p>
<p>For the second property, I have added all necessary conditions which trigger the bypass state and asserted its expected outcome. I have used <code>f_past_valid</code> to keep track of <code>$past()</code>.</p>
<pre style="background-color:darkgrey"><code>if ($past(<span class="hljs-name">we</span>) &amp; $past(<span class="hljs-name">re</span>) &amp; ($past(<span class="hljs-name">waddr</span>) == $past(<span class="hljs-name">raddr</span>)) &amp; ENABLE_BYPASS &amp; f_past_valid)
        assert (<span class="hljs-name">dout</span> == $past(<span class="hljs-name">din</span>))<span class="hljs-comment">;</span>
</code></pre><p>The third property covers the rest of the cases other than bypass and clear. It checks for the normal read and writes operation of dpram. On read request, data is put on the output data port in the next clock cycle. Similarly, data written into memory can be observed after one clock cycle.</p>
<pre style="background-color:darkgrey"><code>      if ($past(<span class="hljs-name">we</span>) &amp; f_past_valid)
        assert (<span class="hljs-name">mem</span>[$past(<span class="hljs-name">waddr</span>)] == $past(<span class="hljs-name">din</span>))<span class="hljs-comment">;</span>

      if ($past(<span class="hljs-name">re</span>) &amp; f_past_valid &amp; !ENABLE_BYPASS)
        assert (<span class="hljs-name">dout</span> == $past(<span class="hljs-name">mem</span>[raddr]))<span class="hljs-comment">;</span>
</code></pre><p>Here, is the complete formal section of simple dpram.</p>
<pre style="background-color:darkgrey"><code><span class="hljs-comment">/*-----Formal checking------*/</span>
<span class="hljs-meta">`<span class="hljs-meta-keyword">ifdef</span> FORMAL</span>
   <span class="hljs-keyword">reg</span> f_past_valid;
   <span class="hljs-keyword">reg</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] address;
   <span class="hljs-keyword">initial</span> f_past_valid = <span class="hljs-number">1'b0</span>;
   <span class="hljs-keyword">initial</span> rdata = <span class="hljs-number">0</span>;
   <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk)
      f_past_valid &lt;= <span class="hljs-number">1'b1</span>;
   <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(we) &amp; <span class="hljs-built_in">$past</span>(re) &amp; (<span class="hljs-built_in">$past</span>(waddr) == <span class="hljs-built_in">$past</span>(raddr)) &amp; ENABLE_BYPASS &amp; f_past_valid)
        <span class="hljs-keyword">assert</span> (dout == <span class="hljs-built_in">$past</span>(din));
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(we) &amp; f_past_valid)
        <span class="hljs-keyword">assert</span> (mem[<span class="hljs-built_in">$past</span>(waddr)] == <span class="hljs-built_in">$past</span>(din));
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(re) &amp; f_past_valid &amp; !ENABLE_BYPASS)
        <span class="hljs-keyword">assert</span> (dout == <span class="hljs-built_in">$past</span>(mem[raddr]));
      <span class="hljs-keyword">if</span> (CLEAR_ON_INIT) <span class="hljs-keyword">begin</span>
        <span class="hljs-keyword">for</span> (address = <span class="hljs-number">0</span>; address &lt; (<span class="hljs-number">1</span>&lt;&lt;ADDR_WIDTH); address = address + <span class="hljs-number">1</span>) 
           <span class="hljs-keyword">assert</span> (mem[address] == <span class="hljs-number">32'd0</span>);
      <span class="hljs-keyword">end</span>
   <span class="hljs-keyword">end</span>
<span class="hljs-meta">`<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<br>
<h4 id="true-dpram">True DPRAM</h4>
<p><a href="https://github.com/Harshitha172000/mor1kx/blob/formal/rtl/verilog/mor1kx_true_dpram_sclk.v">True DPRAM</a>’s properties are somewhat similar to simple DPRAM but use two clocks, one for each port. I have used a global clock to handle two clocks A and B. At the posedge of clk_a or clk_b read and write operations of that port are verified.</p>
<pre style="background-color:darkgrey"><code><span class="hljs-comment">/*------Formal Checking-------*/</span>
<span class="hljs-meta">`<span class="hljs-meta-keyword">ifdef</span> FORMAL</span>
   <span class="hljs-keyword">reg</span> f_past_valid;
   <span class="hljs-keyword">initial</span> f_past_valid = <span class="hljs-number">1'b0</span>;
   (* gclk *) <span class="hljs-keyword">reg</span> global_clock;
   <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> global_clock) <span class="hljs-keyword">begin</span>
      f_past_valid = <span class="hljs-number">1'b1</span>;
      <span class="hljs-keyword">assume</span> (addr_a != addr_b);
   <span class="hljs-keyword">end</span>
   <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> global_clock) <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$rose</span>(clk_a)) <span class="hljs-keyword">begin</span>
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(we_a) &amp; f_past_valid)
            <span class="hljs-keyword">assert</span> (dout_a == <span class="hljs-built_in">$past</span>(din_a));
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(!we_a) &amp; f_past_valid)
            <span class="hljs-keyword">assert</span> (<span class="hljs-built_in">$past</span>(mem[addr_a]) == dout_a);
      <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$rose</span>(clk_b)) <span class="hljs-keyword">begin</span>
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(we_b) &amp; f_past_valid)
            <span class="hljs-keyword">assert</span> (dout_b == <span class="hljs-built_in">$past</span>(din_b));
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">$past</span>(!we_b) &amp; f_past_valid)
            <span class="hljs-keyword">assert</span> (<span class="hljs-built_in">$past</span>(mem[addr_b]) == dout_b);
      <span class="hljs-keyword">end</span>
   <span class="hljs-keyword">end</span>
<span class="hljs-meta">`<span class="hljs-meta-keyword">endif</span></span>
</code></pre><p>I would like to highlight the importance of initial assumptions. Initially, I didn’t give much importance to initial assumptions, when I was stuck with BMC failures then I realized their significance. If these assumptions were included, then the solver starts with the good state and checks our assertions for N bounded steps. BMC is completely dependent on initial assumptions, if not assumed correctly then it&#39;s quite obvious that BMC fails. </p>
<br><h4 id="lru-algorithm">LRU algorithm</h4>
<p>Having verified DPRAM, I moved onto the <a href="https://github.com/Harshitha172000/mor1kx/blob/formal/rtl/verilog/mor1kx_cache_lru.v">least recently used algorithm</a> which is used to replace the least recently used a block from cache. This is a fully combinational design module so it&#39;s much easier to verify. </p>
<p>First, I assumed that inputs to variable access are one-hot encoded just to avoid random inputs that solvers might consider. Since this is an algorithm, I tried to verify its outcomes and asserted if the <code>lru_pre</code> (before access) and <code>lru_post</code> (after access) are also one-hot encoded.</p>
<p>After adding formal declarations to the source file, the very next step is to <a href="https://symbiyosys.readthedocs.io/en/latest/reference.html">configure the SBY file</a>.
Under options, the mode of testing has to be specified along with the depth of iterations. Yosys supports solvers like z3, yices, boolector, etc for the smtbmc engine. If not specified, then the smtbmc engine picks any of the above solvers. One last step is to add design files and script specifying the top module. On running the SBY file, one would get to know what&#39;s the result of verification.</p>
<pre style="background-color:darkgrey"><code>[<span class="hljs-keyword">options</span>]
mode <span class="hljs-keyword">prove</span>
depth <span class="hljs-number">30</span>
wait <span class="hljs-keyword">on</span>
[<span class="hljs-keyword">engines</span>]
smtbmc yices
[<span class="hljs-keyword">script</span>]
<span class="hljs-keyword">read</span> -formal mor1kx_true_dpram_sclk.v
<span class="hljs-keyword">prep</span> -top mor1kx_true_dpram_sclk
[<span class="hljs-keyword">files</span>]
../../rtl/verilog/mor1kx_true_dpram_sclk.v
</code></pre><p>We have seen that all the properties I have tested on Mor1kx&#39;s DPRAM and LRU algorithm are satisfied. Now, I will be moving on to the instruction cache verification. For the upcoming week, I plan to verify the Instruction memory management unit and Instruction fetch modules. I am hoping to find some interesting parts of Mor1kx there.</p>
                              
                             <!-- <span class="d-block text-right tm-color-primary">Creative . Design . Business</span>-->
                        </div>
                    </div>                    
                </div>
            
                        
                        <!-- Comments 
                        <div>
                            <h2 class="tm-color-primary tm-post-title">Comments</h2>
                            <hr class="tm-hr-primary tm-mb-45">
                           
                            <form action="" class="mb-5 tm-comment-form">
                                <h2 class="tm-color-primary tm-post-title mb-4">Your comment</h2>
                                <div class="mb-4">
                                    <input class="form-control" name="name" type="text">
                                </div>
                                <div class="mb-4">
                                    <input class="form-control" name="email" type="text">
                                </div>
                                <div class="mb-4">
                                    <textarea class="form-control" name="message" rows="6"></textarea>
                                </div>
                                <div class="text-right">
                                    <button class="tm-btn tm-btn-primary tm-btn-small">Submit</button>                        
                                </div>                                
                            </form>                          
                        </div>-->
                    </div>
                </div>
            </div>
                <!--<aside class="col-lg-4 tm-aside-col">
                    <div class="tm-post-sidebar">
                        <hr class="mb-3 tm-hr-primary">
                        <h2 class="mb-4 tm-post-title tm-color-primary">Categories</h2>
                        <ul class="tm-mb-75 pl-5 tm-category-list">
                            <li><a href="#" class="tm-color-primary">Visual Designs</a></li>
                            <li><a href="#" class="tm-color-primary">Travel Events</a></li>
                            <li><a href="#" class="tm-color-primary">Web Development</a></li>
                            <li><a href="#" class="tm-color-primary">Video and Audio</a></li>
                            <li><a href="#" class="tm-color-primary">Etiam auctor ac arcu</a></li>
                            <li><a href="#" class="tm-color-primary">Sed im justo diam</a></li>
                        </ul>
                        <hr class="mb-3 tm-hr-primary">
                        <h2 class="tm-mb-40 tm-post-title tm-color-primary">Related Posts</h2>
                        <a href="#" class="d-block tm-mb-40">
                            <figure>
                                <img src="img/capp.png" alt="Image" class="mb-3 img-fluid">
                                <figcaption class="tm-color-primary">Duis mollis diam nec ex viverra scelerisque a sit</figcaption>
                            </figure>
                        </a>
                        <a href="#" class="d-block tm-mb-40">
                            <figure>
                                <img src="img/img-05.jpg" alt="Image" class="mb-3 img-fluid">
                                <figcaption class="tm-color-primary">Integer quis lectus eget justo ullamcorper ullamcorper</figcaption>
                            </figure>
                        </a>
                        <a href="#" class="d-block tm-mb-40">
                            <figure>
                                <img src="img/img-06.jpg" alt="Image" class="mb-3 img-fluid">
                                <figcaption class="tm-color-primary">Nam lobortis nunc sed faucibus commodo</figcaption>
                            </figure>
                        </a>
                    </div>                    
                </aside>-->
            </div>
            <footer class="row tm-row">
               
              <!--  <div class="col-md-6 col-12 tm-color-gray">
                    
                    Design: <a rel="nofollow" target="_parent" href="https://templatemo.com" class="tm-external-link">TemplateMo</a>
                </div>-->
                <!--  <div class="col-md-6 col-12 tm-color-gray tm-copyright">
                    Copyright 2020 Xtra Blog Company Co. Ltd.
                </div>-->
            </footer> 
        </main>
    </div>
    <script src="js/jquery.min.js"></script>
    <script src="js/templatemo-script.js"></script>
</body>
</html>